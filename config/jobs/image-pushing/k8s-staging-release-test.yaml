# Test job generation with:
#   go run prow/cmd/mkpj/main.go \
#     -base-ref master -local -config-path config/prow/config.yaml \
#     -job-config-path config/jobs/image-pushing/k8s-staging-release-test.yaml \
#     -job post-release-push-image-k8s-cloud-builder

presets:
- labels:
    preset-releng-creds: "true"
  env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /creds/service-account.json
  volumeMounts:
    - name: creds
      mountPath: /creds
  volumes:
    - name: creds
      secret:
        secretName: deployer-service-account
- labels:
    preset-releng-log-to-stdout: "true"
  env:
    - name: LOG_TO_STDOUT
      value: "y"

periodics:
# TODO(justaugustus): Decrease interval to 1hr once we cut build over to k8s-infra.
#                     ref: https://github.com/kubernetes/release/issues/911
- interval: 4h
  name: ci-kubernetes-prototype-build
  cluster: test-infra-trusted
  labels:
    preset-releng-creds: "true"
    preset-releng-log-to-stdout: "true"
  decorate: true
  extra_refs:
  - org: kubernetes
    repo: release
    base_ref: master
    path_alias: "k8s.io/release"
  spec:
    containers:
    - image: gcr.io/k8s-testimages/image-builder:v20200107-6bdb17e
      command:
        - /run.sh
      args:
        - --project=k8s-staging-release-test
        - --scratch-bucket=gs://k8s-staging-release-test-gcb
        - --variant=build-ci
        - --no-source
        - gcb/build
  annotations:
    # TODO(justaugustus): Enable forking for prototype GCB-based build jobs.
    testgrid-dashboards: sig-release-prototype-master-blocking
    testgrid-tab-name: build-master
    testgrid-alert-email: release-managers@kubernetes.io

# TODO(justaugustus): Decrease interval to 5m once we cut build over to k8s-infra.
#                     ref: https://github.com/kubernetes/release/issues/911
- interval: 12h
  name: ci-kubernetes-prototype-build-fast
  cluster: test-infra-trusted
  labels:
    preset-releng-creds: "true"
    preset-releng-log-to-stdout: "true"
  decorate: true
  extra_refs:
  - org: kubernetes
    repo: release
    base_ref: master
    path_alias: "k8s.io/release"
  spec:
    containers:
    - image: gcr.io/k8s-testimages/image-builder:v20200107-6bdb17e
      command:
        - /run.sh
      args:
        - --project=k8s-staging-release-test
        - --scratch-bucket=gs://k8s-staging-release-test-gcb
        - --variant=build-ci-fast
        - --no-source
        - gcb/build
  annotations:
    testgrid-dashboards: sig-release-prototype-master-blocking
    testgrid-tab-name: build-master-fast
    testgrid-alert-email: release-managers@kubernetes.io
    description: 'Ends up running: make quick-release'

# x-releng-config is not used by prow, we just use that here to have a
# container for all the yaml anchors we want to reuse later.
x-releng-config:
  default-image-builder-container: &default-image-builder-container
    image: gcr.io/k8s-testimages/image-builder:v20200107-6bdb17e
    command:
      - /run.sh
    args:
      - --project=k8s-staging-release-test
      - --scratch-bucket=gs://k8s-staging-release-test-gcb
      - --env-passthrough=PULL_BASE_REF
      - $(IMAGE_SRC_DIR)
  default-image-builder-job: &default-image-builder-job
    cluster: test-infra-trusted
    labels:
      preset-releng-creds: "true"
      preset-releng-log-to-stdout: "true"
    annotations:
      testgrid-dashboards: sig-release-image-pushes, sig-release-master-informing
      testgrid-alert-email: release-managers@kubernetes.io
    decorate: true
    branches: [ ^master$ ]

postsubmits:
  kubernetes/release:
    - name: post-release-push-image-k8s-cloud-builder
      <<: *default-image-builder-job
      run_if_changed: '^images\/'
      spec:
        containers:
          - <<: *default-image-builder-container
            env: [{ name: IMAGE_SRC_DIR, value: images/k8s-cloud-builder }]

    - name: post-release-push-image-releng-ci-bazel
      <<: *default-image-builder-job
      run_if_changed: '^images\/'
      spec:
        containers:
        - <<: *default-image-builder-container
          env: [{ name: IMAGE_SRC_DIR, value: images/releng-ci-bazel }]

    - name: post-release-push-image-deb-builder
      <<: *default-image-builder-job
      run_if_changed: '^build\/'
      spec:
        containers:
        - <<: *default-image-builder-container
          env: [{ name: IMAGE_SRC_DIR, value: build/debs }]

    - name: post-release-push-image-rpm-builder
      <<: *default-image-builder-job
      run_if_changed: '^build\/'
      spec:
        containers:
        - <<: *default-image-builder-container
          env: [{ name: IMAGE_SRC_DIR, value: build/rpms }]
